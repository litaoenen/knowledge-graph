"use strict";(self.webpackChunkknowledge_graph=self.webpackChunkknowledge_graph||[]).push([[784],{312:(e,t,i)=>{i.d(t,{E:()=>s,G:()=>n});var o=i(238);const s=async e=>{const t=(0,o.LF)(e),i=t.Sheets[t.SheetNames[0]];return o.Wp.sheet_to_json(i).map((e=>({id:e["\u7f16\u53f7"],label:e.Name,type:r(e["\u7f16\u53f7"]),difficulty:Number(e.Difficulty_degree)||0,importance:Number(e.Importance_degree)||0,description:e.Description})))},n=async e=>{const t=(0,o.LF)(e),i=t.Sheets[t.SheetNames[0]];return o.Wp.sheet_to_json(i).map((e=>({id:e["\u7f16\u53f7"],label:e.Name,name:e.Label,type:r(e["\u7f16\u53f7"]),difficulty:Number(e["\u96be\u5ea6"])||0,importance:Number(e["\u91cd\u8981\u6027"])||0,description:e["\u63cf\u8ff0"],tag:e["\u6807\u7b7e"]})))},r=e=>{switch(e.length){case 2:return"chapter";case 4:return"section";case 6:return"subsection";case 8:return"point";default:return"detail"}}},784:(e,t,i)=>{i.r(t),i.d(t,{default:()=>f});var o=i(43),s=i(435),n=i(37),r=i(312),a=i(666),l=i(52),c=i(951),d=i(309),p=i(579);const h=e=>{let{node:t,onClick:i,onDragStart:n,onDrag:r,onDragEnd:h,isSelected:u}=e;const m=(0,o.useRef)(null),[x,f]=(0,o.useState)(!1),[g,y]=(0,o.useState)(!1),[j,w]=(0,o.useState)(null),{camera:v}=(0,a.A)(),P=u?{color:"#FFD700",emissive:"#FF4500",emissiveIntensity:.5}:{color:t.color,emissive:t.color,emissiveIntensity:.2},b="knowledge"===t.nodeType;t.radius;(0,o.useEffect)((()=>{m.current&&t.position&&m.current.position.copy(t.position)}),[]),(0,o.useEffect)((()=>{if(m.current&&t.position&&!x)try{const e=m.current.position,i=t.position;e.distanceTo(i)>.05&&e.lerp(i,.3)}catch(e){console.error("\u8282\u70b9\u4f4d\u7f6e\u66f4\u65b0\u9519\u8bef:",e),w("\u8282\u70b9\u4f4d\u7f6e\u66f4\u65b0\u5931\u8d25")}}),[t.position,x]);return j?(0,p.jsxs)("mesh",{position:[t.position.x,t.position.y,t.position.z],children:[(0,p.jsx)("boxGeometry",{args:[t.radius,t.radius,.1]}),(0,p.jsx)("meshBasicMaterial",{color:"#ff0000"})]}):(0,p.jsxs)("group",{children:[(0,p.jsxs)("mesh",{ref:m,position:[t.position.x,t.position.y,t.position.z],onPointerDown:e=>{try{var i,o,s;e.stopPropagation(),null===(i=e.nativeEvent)||void 0===i||null===(o=i.preventDefault)||void 0===o||o.call(i);const r=null===(s=m.current)||void 0===s?void 0:s.position.clone();f(!1),m.current&&r&&n(t.id,r)}catch(r){console.error("\u8282\u70b9\u70b9\u51fb\u9519\u8bef:",r),w("\u8282\u70b9\u4ea4\u4e92\u5931\u8d25")}},onPointerMove:e=>{if(m.current&&e.point)try{if(e.stopPropagation(),1!==e.buttons)return;if(!x)return void f(!0);const i=new s.tBo;i.setFromCamera(e.point,v);const o=b?-5:5,n=new s.Zcv(new s.Pq0(0,0,1),-o),a=new s.Pq0;if(i.ray.intersectPlane(n,a)){const e=m.current.position;if(new s.Pq0(a.x,a.y,e.z).distanceTo(e)<10){const i=e.x+.5*(a.x-e.x),o=e.y+.5*(a.y-e.y);m.current.position.x=i,m.current.position.y=o,r(t.id,m.current.position.clone())}}}catch(i){console.error("\u8282\u70b9\u62d6\u62fd\u9519\u8bef:",i),w("\u62d6\u62fd\u64cd\u4f5c\u5931\u8d25")}},onPointerUp:e=>{try{e.stopPropagation(),x?(f(!1),h(t.id)):(console.log("\u8282\u70b9\u70b9\u51fb:",t.id),i(t.id))}catch(o){console.error("\u8282\u70b9\u91ca\u653e\u9519\u8bef:",o),w("\u8282\u70b9\u64cd\u4f5c\u5931\u8d25")}},onPointerEnter:e=>{try{e.stopPropagation(),y(!0),document.body.style.cursor="pointer"}catch(t){console.error("\u6307\u9488\u60ac\u505c\u9519\u8bef:",t)}},onPointerLeave:e=>{try{e.stopPropagation(),y(!1),document.body.style.cursor="auto"}catch(t){console.error("\u6307\u9488\u79bb\u5f00\u9519\u8bef:",t)}},children:[(0,p.jsx)("sphereGeometry",{args:[t.radius,32,32]}),(0,p.jsx)("meshStandardMaterial",{...P})]}),(0,p.jsx)(l.Q,{position:[t.position.x,t.position.y,t.position.z],children:(0,p.jsx)(c.E,{position:[0,1.2*t.radius,0],fontSize:.6,color:"#ffffff",anchorX:"center",anchorY:"middle",outlineWidth:.1,outlineColor:"#000000",fontWeight:"bold",renderOrder:2,children:t.label})}),g&&(0,p.jsx)(d.E,{position:[t.position.x+1.5*t.radius,t.position.y+1.5*t.radius,t.position.z],style:{pointerEvents:"none",zIndex:1e4},center:!1,distanceFactor:0,className:"tooltip-container-static",wrapperClass:"",scale:1,occlude:!1,transform:!0,sprite:!0,calculatePosition:(e,i,o)=>[t.position.x+1.5*t.radius,t.position.y+1.5*t.radius,t.position.z],children:(0,p.jsxs)("div",{className:"drei-tooltip-static",children:[(0,p.jsxs)("div",{className:"drei-tooltip-header",children:[(0,p.jsx)("span",{className:"drei-tooltip-dot",style:{backgroundColor:t.color}}),t.label]}),(0,p.jsxs)("div",{className:"drei-tooltip-content",children:[(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"ID:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.id})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u7c7b\u578b:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.type})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u8282\u70b9\u7c7b\u578b:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:"knowledge"===t.nodeType?"\u77e5\u8bc6\u70b9":"\u80fd\u529b\u70b9"})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u91cd\u8981\u6027:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.importance||"\u672a\u8bbe\u7f6e"})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u96be\u5ea6:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.difficulty||"\u672a\u8bbe\u7f6e"})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u6807\u7b7e:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.tag||"\u65e0"})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u5b50\u8282\u70b9:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.children.length})]}),(0,p.jsxs)("div",{className:"drei-tooltip-item",children:[(0,p.jsx)("span",{className:"drei-tooltip-label",children:"\u72b6\u6001:"}),(0,p.jsx)("span",{className:"drei-tooltip-value",children:t.isExpanded?"\u5df2\u5c55\u5f00":"\u5df2\u6536\u8d77"})]}),t.description&&(0,p.jsxs)("div",{className:"drei-tooltip-description",children:[(0,p.jsx)("div",{className:"drei-tooltip-label",children:"\u63cf\u8ff0:"}),(0,p.jsx)("div",{className:"drei-tooltip-value",children:t.description})]})]})]})})]})},u=e=>{let{edge:t,isSelected:i=!1}=e;const[n,r]=(0,o.useState)(null);try{if(!t.sourcePosition||!t.targetPosition)throw new Error("\u65e0\u6548\u7684\u8fb9\u7f18\u6570\u636e");const e=new s.Pq0(t.sourcePosition.x,t.sourcePosition.y,t.sourcePosition.z),o=new s.Pq0(t.targetPosition.x,t.targetPosition.y,t.targetPosition.z),n=Math.abs(e.z-o.z)>20;e.distanceTo(o);if(n){const t=(new s.Pq0).addVectors(e,o).divideScalar(2),n=new s.Pq0(t.x,t.y,0),r=new s.CV9(e,n,o).getPoints(50),a=(new s.LoY).setFromPoints(r),l=(new s.Pq0).subVectors(o,e).normalize();return(0,p.jsxs)("group",{children:[(0,p.jsx)("primitive",{object:new s.N1A(a,new s.mrM({color:i?"#ffcc00":"#aaaaaa",linewidth:2,opacity:.8,transparent:!0}))}),r.length>30&&(0,p.jsxs)("mesh",{position:r[30].toArray(),scale:.2,rotation:[0,0,Math.atan2(l.y,l.x)],children:[(0,p.jsx)("coneGeometry",{args:[.5,1,8]}),(0,p.jsx)("meshBasicMaterial",{color:i?"#ffcc00":"#aaaaaa"})]})]})}{const t=(new s.Pq0).subVectors(o,e).normalize(),n=e.distanceTo(o),r=(new s.Pq0).addVectors(e,o).divideScalar(2),a=Math.min(1,n/15),l=new s.Pq0(-t.y,t.x,0).normalize(),c=.25*n*a*(Math.random()>.5?1:-1),d=new s.Pq0(r.x+l.x*c,r.y+l.y*c,r.z+(.4*Math.random()-.2)),h=new s.CV9(e,d,o),u=h.getPoints(50),m=(new s.LoY).setFromPoints(u),x=h.getPoint(.75),f=h.getTangent(.75).normalize();return(0,p.jsxs)("group",{children:[(0,p.jsx)("primitive",{object:new s.N1A(m,new s.mrM({color:i?"#ffcc00":"#aaaaaa",linewidth:2,opacity:.8,transparent:!0}))}),(0,p.jsxs)("mesh",{position:x.toArray(),scale:.2,rotation:[Math.PI/2,0,Math.atan2(f.y,f.x)],children:[(0,p.jsx)("coneGeometry",{args:[.5,1,8]}),(0,p.jsx)("meshBasicMaterial",{color:i?"#ffcc00":"#aaaaaa"})]})]})}}catch(a){if(console.error("\u8fb9\u7f18\u6e32\u67d3\u9519\u8bef:",a),n||r(a instanceof Error?a.message:"\u672a\u77e5\u9519\u8bef"),t.sourcePosition&&t.targetPosition){const e=new s.Pq0(t.sourcePosition.x,t.sourcePosition.y,t.sourcePosition.z),i=new s.Pq0(t.targetPosition.x,t.targetPosition.y,t.targetPosition.z),o=(new s.LoY).setFromPoints([e,i]);return(0,p.jsx)("primitive",{object:new s.N1A(o,new s.mrM({color:"#ff0000",linewidth:1}))})}}return null};var m=i(583);(0,a.e)({OrbitControls:m.N});const x=e=>{let{children:t}=e;const{camera:i,gl:s}=(0,a.A)(),[n,r]=(0,o.useState)(null),l=(0,o.useRef)(null);return(0,o.useEffect)((()=>{try{i.position.set(0,0,50),i.lookAt(0,0,0);const e=new m.N(i,s.domElement);l.current=e,e.enabled=!0,e.enableDamping=!0,e.dampingFactor=.1,e.rotateSpeed=.8,e.zoomSpeed=1,e.enableZoom=!0,e.screenSpacePanning=!0,e.minPolarAngle=0,e.maxPolarAngle=Math.PI,e.autoRotate=!1,e.minDistance=5,e.maxDistance=200;const t=()=>{requestAnimationFrame(t),e&&e.update()};return t(),()=>{e.dispose()}}catch(e){console.error("\u63a7\u5236\u5668\u521d\u59cb\u5316\u9519\u8bef:",e),r("\u573a\u666f\u521d\u59cb\u5316\u5931\u8d25")}}),[i,s]),n?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("ambientLight",{intensity:.5}),(0,p.jsx)("pointLight",{position:[10,10,10]}),(0,p.jsxs)("mesh",{position:[0,0,0],children:[(0,p.jsx)("boxGeometry",{args:[1,1,1]}),(0,p.jsx)("meshStandardMaterial",{color:"#ff0000"})]}),(0,p.jsx)("gridHelper",{})]}):(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("ambientLight",{intensity:.5}),(0,p.jsx)("directionalLight",{position:[10,40,30],intensity:.8,castShadow:!0,"shadow-mapSize-width":1024,"shadow-mapSize-height":1024}),(0,p.jsx)("directionalLight",{position:[-20,10,20],intensity:.4,color:"#aabbff"}),(0,p.jsx)("directionalLight",{position:[0,-10,-30],intensity:.3,color:"#ffeecc"}),(0,p.jsx)("spotLight",{position:[0,30,0],angle:Math.PI/3,penumbra:.2,intensity:.5,color:"#ffffff",distance:60}),(0,p.jsx)("color",{attach:"background",args:["#f5f5f5"]}),t]})},f=()=>{const[e,t]=(0,o.useState)([]),[i,a]=(0,o.useState)([]),[l,c]=(0,o.useState)([]),[d,m]=(0,o.useState)([]),[f,g]=(0,o.useState)(!0),[y,j]=(0,o.useState)(null),[w,v]=(0,o.useState)(new Set(["DS","AB"])),[P,b]=(0,o.useState)(null);(0,o.useEffect)((()=>{(async()=>{try{g(!0),j(null);const e=await fetch("/knowledge_graph.xlsx");if(!e.ok)throw new Error("\u77e5\u8bc6\u56fe\u8c31Excel\u6587\u4ef6\u52a0\u8f7d\u5931\u8d25");const i=await e.arrayBuffer(),o=await(0,r.E)(i);if(!o||0===o.length)throw new Error("\u77e5\u8bc6\u56fe\u8c31Excel\u6587\u4ef6\u4e3a\u7a7a\u6216\u683c\u5f0f\u4e0d\u6b63\u786e");t(o);const s=await fetch("/ability_graph.xlsx");if(!s.ok)throw new Error("\u80fd\u529b\u56fe\u8c31Excel\u6587\u4ef6\u52a0\u8f7d\u5931\u8d25");const n=await s.arrayBuffer(),l=await(0,r.G)(n);if(!l||0===l.length)throw new Error("\u80fd\u529b\u56fe\u8c31Excel\u6587\u4ef6\u4e3a\u7a7a\u6216\u683c\u5f0f\u4e0d\u6b63\u786e");a(l)}catch(y){console.error("Failed to load Excel files:",y),j(y instanceof Error?y.message:"\u672a\u77e5\u9519\u8bef")}finally{g(!1)}})()}),[]);const N=e=>{console.log("\u8282\u70b9\u70b9\u51fb:",e),b(e),v((t=>{const i=new Set(t);return i.has(e)?(console.log("\u6536\u8d77\u8282\u70b9:",e),i.delete(e)):(console.log("\u5c55\u5f00\u8282\u70b9:",e),i.add(e)),i}))},S=(e,t)=>{console.log(`\u5f00\u59cb\u62d6\u62fd\u8282\u70b9: ${e}`,t)},E=(e,t)=>{c((i=>i.map((o=>{if(o.id===e)return{...o,position:t.clone()};if(o.id.startsWith(e)&&o.id!==e){const n=i.find((t=>t.id===e));if(n){const e=t.x-n.position.x,i=t.y-n.position.y;return{...o,position:new s.Pq0(o.position.x+e,o.position.y+i,o.position.z)}}}return o})))),q()},M=e=>{console.log(`\u7ed3\u675f\u62d6\u62fd\u8282\u70b9: ${e}`)},D=(e,t)=>{const i=new Map;return e.forEach((e=>{const o="knowledge"===t,n=o?-5:5;let r="#3a86ff";r=o?"chapter"===e.type||"section"===e.type?"#3a86ff":"#ff006e":"chapter"===e.type||"section"===e.type?"#ffd700":"#ff9900",i.set(e.id,{...e,nodeType:t,children:[],position:new s.Pq0(0,0,n),color:r,radius:.6+.8*(e.importance||.5),isExpanded:w.has(e.id)})})),e.forEach((e=>{if("DS"===e.id||"AB"===e.id)return;let t="";(e.id.startsWith("DS")||e.id.startsWith("AB"))&&e.id.length>2&&(t=e.id.slice(0,-2),""===t&&(t=e.id.startsWith("DS")?"DS":"AB"));const o=i.get(t),s=i.get(e.id);o&&s&&o.children.push(s)})),Array.from(i.values())},A=(e,t)=>{const i=[],o=(e,s)=>{if("DS"===e.id||"AB"===e.id||s){i.push(e);const n=t.has(e.id);e.children.forEach((e=>{o(e,s&&n)}))}};return e.filter((e=>"DS"===e.id||"AB"===e.id)).forEach((e=>o(e,!0))),i},z=e=>{const t=e.find((e=>"DS"===e.id)),i=e.find((e=>"AB"===e.id));t&&t.position.set(0,0,-5),i&&i.position.set(0,0,5);const o=(e,t,i,s,n)=>{if(0===e.children.length)return;const r=i/e.children.length,a=Math.max(1,Math.min(1.5,e.children.length/5));e.children.forEach(((e,i)=>{let l=0;if(0===s)l=12*(.2*Math.random()-.1+1);else{l=12*(1+.6*s*a);const e=.15*l;l+=Math.random()*e-e/2}const c=(.3*Math.random()-.15)*r,d=t+i*r+r/2+c,p=0+l*Math.cos(d),h=0+l*Math.sin(d),u=.4*Math.random()-.2;e.position.set(p,h,n+u);const m=.9*r;o(e,d-m/2,m,s+1,n)}))};return t&&o(t,0,2*Math.PI,0,-5),i&&o(i,0,2*Math.PI,0,5),e},k=e=>{const t=[];return e.forEach((i=>{if("DS"===i.id||"AB"===i.id)return;let o="";(i.id.startsWith("DS")||i.id.startsWith("AB"))&&i.id.length>2&&(o=i.id.slice(0,-2),""===o&&(o=i.id.startsWith("DS")?"DS":"AB"));const s=e.find((e=>e.id===o));s&&t.push({source:o,target:i.id,sourcePosition:s.position,targetPosition:i.position})})),t},q=()=>{m((e=>e.map((e=>{const t=l.find((t=>t.id===e.source)),i=l.find((t=>t.id===e.target));return t&&i?{...e,sourcePosition:t.position,targetPosition:i.position}:e}))))};return(0,o.useEffect)((()=>{if(f||0===e.length||0===i.length)return;const t=[...D(e,"knowledge"),...D(i,"ability")],o=A(t,w),s=z(o);c(s);const n=k(s);m(n)}),[e,i,f]),(0,o.useEffect)((()=>{if(0===l.length||!e.length||!i.length)return;const t=requestAnimationFrame((()=>{try{const t=D(e,"knowledge"),o=D(i,"ability"),s=[...t,...o],n=A(s,w),r=z(n);console.log("\u8282\u70b9\u66f4\u65b0:",r.length,"\u5c55\u5f00\u8282\u70b9:",Array.from(w)),c(r);const a=k(r);m(a)}catch(y){console.error("\u8282\u70b9\u5c55\u5f00\u65f6\u51fa\u9519:",y)}}));return()=>cancelAnimationFrame(t)}),[w,e,i]),f?(0,p.jsx)("div",{style:{width:"100%",height:"80vh",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,p.jsxs)("div",{className:"loading-container",children:[(0,p.jsx)("div",{className:"loading-spinner"}),(0,p.jsx)("div",{children:"\u52a0\u8f7d\u4e2d..."})]})}):y?(0,p.jsx)("div",{style:{width:"100%",height:"80vh",display:"flex",alignItems:"center",justifyContent:"center",color:"#e74c3c"},children:(0,p.jsxs)("div",{className:"error-message",children:["\u9519\u8bef: ",y]})}):(0,p.jsxs)("div",{style:{width:"100%",height:"80vh",position:"relative"},children:[(0,p.jsx)(n.Hl,{camera:{position:[0,0,30],fov:50},children:(0,p.jsx)(x,{children:(0,p.jsxs)("group",{rotation:[0,0,0],children:[l.filter((e=>e.position&&"number"===typeof e.position.x)).map((e=>(0,p.jsx)(h,{node:{...e,isExpanded:w.has(e.id)},onClick:N,onDragStart:S,onDrag:E,onDragEnd:M,isSelected:P===e.id},e.id))),d.filter((e=>e.sourcePosition&&e.targetPosition&&"number"===typeof e.sourcePosition.x&&"number"===typeof e.targetPosition.x)).map((e=>(0,p.jsx)(u,{edge:e,isSelected:P===e.source||P===e.target},`${e.source}-${e.target}`))),(0,p.jsx)("primitive",{object:new s.N1A((new s.LoY).setFromPoints([new s.Pq0(0,0,-5),new s.Pq0(0,0,5)]),new s.mrM({color:"#999999",opacity:.3,transparent:!0}))})]})})}),(0,p.jsxs)("div",{style:{position:"absolute",bottom:"10px",left:"10px",padding:"5px 10px",backgroundColor:"rgba(0,0,0,0.5)",color:"white",borderRadius:"5px"},children:[(0,p.jsxs)("div",{style:{display:"flex",alignItems:"center",marginBottom:"5px"},children:[(0,p.jsx)("div",{style:{width:"12px",height:"12px",backgroundColor:"#3a86ff",marginRight:"5px",borderRadius:"50%"}}),(0,p.jsx)("span",{children:"\u77e5\u8bc6\u56fe\u8c31\uff08\u5e95\u9762\uff09"})]}),(0,p.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,p.jsx)("div",{style:{width:"12px",height:"12px",backgroundColor:"#ffd700",marginRight:"5px",borderRadius:"50%"}}),(0,p.jsx)("span",{children:"\u80fd\u529b\u56fe\u8c31\uff08\u9876\u9762\uff09"})]})]}),(0,p.jsxs)("div",{style:{position:"absolute",top:"10px",right:"10px",padding:"5px 10px",backgroundColor:"rgba(0,0,0,0.5)",color:"white",borderRadius:"5px"},children:[(0,p.jsxs)("div",{children:["\u8282\u70b9\u6570\u91cf: ",l.length]}),(0,p.jsxs)("div",{children:["\u5df2\u5c55\u5f00\u8282\u70b9: ",w.size]}),P&&(0,p.jsxs)("div",{children:["\u9009\u4e2d\u8282\u70b9: ",P]})]})]})}}}]);
//# sourceMappingURL=784.7191dbb5.chunk.js.map